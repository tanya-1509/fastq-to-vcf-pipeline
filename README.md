# FASTQ to VCF Pipeline using GATK best practices

This repository is a guide to create a fastq to vcf pipeline using GATK best practices for preprocessing raw high throughput sequencing data from NGS platforms like Illumina to generate a variant call file which can be used for further downstream analysis.

## Laptop configuration

   * Laptop: ROG Strix G15
   * Processor: Intel(R) Core(TM) i5-10300H CPU @ 2.50GHz (4 cores)
   * RAM: 8 GB
   * System type: 64-bit operating system, x64-based processor
   * Storage: 1 TB
   * OS: Windows 11

## WSL2 Installation

* About Windows Subsystem for Linux (WSL): https://learn.microsoft.com/en-us/windows/wsl/about
* Installation steps: https://learn.microsoft.com/en-us/windows/wsl/install

## Bioinformatics Tools

* BWA (Burrows Wheeler Aligner)
   * Usage: This tool is used for aligning sequencing reads (from FASTQ files) to a reference genome (like the human genome in fasta format). It's particularly efficient for mapping short and long DNA reads generated by platforms like Illumina. For more details about BWA tool: https://bio-bwa.sourceforge.net/
   * Installation: Please follow either one of the tutorials for installing BWA
        1. Using Source code: https://youtu.be/oCEqS42N_7E?si=BVm627bmjaSMpzpx
        2. Using Binaries: https://youtu.be/HBu6atfdZK4?si=IOoFpQnnmQay5t9N
   * Input and Output files:
        1. Input: FASTQ files (reads), FASTA (reference)
        2. Output: SAM file

* Samtools
    * Usage:
      In this pipeline, samtools is mainly used to convert a SAM (Sequence Alignment Map) file to a sorted BAM (Binary Alignment Map) file. For more details: https://www.htslib.org/
    * Installation:
        1. Using Source code: https://youtu.be/ULQU8X3abxY?si=MEQSTPjYaNQLRM85
        2. Using Binaries: https://youtu.be/zauS4C_RtZw?si=oDBRdkPpagM9Jkuu
    * Input and Output files:
        1. Input: SAM file
        2. Output: sorted BAM file

* GATK4
   * Usage: Geneome Analysis Toolkit (GATK) is a collection of command-line tools for analyzing high-throughput sequencing data with a primary focus on variant discovery. For more details about GATK: https://gatk.broadinstitute.org/hc/en-us
   * Installation:
       1. To run GATK:
            * JAVA 17 JDK is required to run and build GATK. Install using the following command:
              ```
              sudo apt install openjdk-17-jre-headless
              ```
            * Python3 is required to run some tools. It is usually preinstalled in Ubuntu.
       2. Download and extract GATK4:
            * Visit the Broad Institute's GATK page (https://github.com/broadinstitute/gatk/releases) and download the latest GATK4 version:
              ```
              wget https://github.com/broadinstitute/gatk/releases/download/4.6.1.0/gatk-4.6.1.0.zip
              ```
            * Extract the contents of the zip file to your desired location:
              ```
              unzip gatk-4.6.1.0.zip
              ```
        3. Add GATK to system's PATH:
           Edit your .bashrc file adding the location of the directory containing the gatk script and the GATK jar files. This allows you to run GATK commands from anywhere in your terminal. 
           ```
           export PATH="$PATH:/path/to/gatk/gatk-4.6.1.0"
           ```
           Replace /path/to/gatk/gatk-4.6.1.0 with the actual path to your GATK directory.

     ***Please follow this tutorial for a detailed explanation: https://youtu.be/haXr1UkaRZU?si=-stX6eIQFI2u2hO5***

  * Input and Output files:
    * Input: sorted BAM file
    * Output: VCF file

## Steps for Pipeline Creation

### STEP 1: Convert FASTQ to SAM
  1. `bwa mem` converts the FASTQ file to SAM file.
  2. Command:
     ```
     bwa mem -t 3 -R "@RG\tID:1\tSM:sample_name\tPL:ILLUMINA\tLB:lib1\tPU:unit1" $REF $FASTQ1 $FASTQ2 > sample_name.sam
     ```
  3. Parameter explanation:
      * `bwa mem`: Calls the BWA aligner with the MEM (Maximal Exact Match) algorithm, which is optimized for high-quality reads and long reads, such as those from Illumina sequencing.
      * `-t 3` Specifies the number of threads to use (here, 3 CPU threads) to speed up alignment. You can change the number of threads as per your PC configeration.
      * `-R "@RG\tID:1\tSM:sample_name\tPL:ILLUMINA\tLB:lib1\tPU:unit1"` Adds Read Group (RG) information, which is important for downstream processing like variant calling. The read group header is formatted as:
         * `@RG` --> Indicates the start of a read group definition.
         * `tID:1` --> Read group ID, typically a unique identifier for a sequencing run. You can use your sample name or even just "1".
         * `tSM:sample_name` --> The biological sample name. Critical for tools like `GATK`.
         * `tPL:ILLUMINA` --> Platform used for sequencing (e.g., ILLUMINA).
         * `tLB:lib1` --> The name of the sequencing library. If you're not sure, use a placeholder like `lib1`. Only matters in some downstream tools.
         * `tPU:unit1` --> Platform unit is a unique identifier for a sequencing run, often a combination of flowcell ID and lane number. if unknown, mention a simple `unit1`.
      * `$REF` - Specifies the path to the reference genome FASTA file (e.g., hg38.fa or ref_genome.fasta). This is to be defined in your shell script.
      * `$FASTQ1` and `$FASTQ2` - These are the input FASTQ files (paired-end reads). `$FASTQ1`  is the forward (R1) read file and `$FASTQ2` is the reverse (R2) read file.

        *`$REF`, `$FASTQ1` and `$FASTQ2` are to be defined in your shell script.*
        ```
        REF="/path/to/your/ref_genome.fa"
        FASTQ1="/path/to/your/sample_1.fastq.gz"
        FASTQ2="/path/to/your/sample_2.fastq.gz"
        ```
     * `> sample_name.sam` - Redirects the output to a SAM file (`sample_name.sam`), which contains the aligned sequencing reads.

### STEP 2: Convert SAM to BAM
1. 'samtools` generates a sorted BAM file from a SAM file.
2. Command:
   ```
   samtools view -bS sample_name.sam | samtools sort -o sample_name.bam
   rm sample_name.sam
   ```
3. Parameter explanation:
     * `samtools view` --> Converts file formats (SAM ↔ BAM).
     * `-b` --> Output in BAM format.
     * `-S` --> Input is in SAM format.
     * `|` --> Passes the output from `samtools view` to the next command (`samtools sort`) without saving an intermediate file.
     * `samtools sort` --> Sorts a BAM file by genomic coordinates (needed for downstream analyses).
     * `-o sample_name.bam` --> Specifies the output sorted BAM file
     * `rm sample_name.sam` --> Removes the SAM file as it not need for further steps.

### STEP 3: Markduplicates
1. To identify and mark duplicate reads in a BAM file.
2. Command:
   ```
   gatk MarkDuplicates -I sample_name.bam -O sample_name.markdup.bam -M sample_name.metrics.txt
   ```
3. Parameter explanation:
     * `gatk MarkDuplicates` --> Runs the GATK MarkDuplicates tool to identify duplicate reads.
     * `-I sample_name.bam` --> Specifies the input BAM file (`sample_name.bam`).
     * `-O sample_name.markdup.bam` --> Specifies the output BAM file (`sample.markdup.bam`) where duplicate reads will be marked.
     * `-M sample_name.metrics.txt` --> Specifies the metrics file (`sample.metrics.txt`) where statistics on detected duplicates will be saved (e.g., number of duplicates found, percentage of reads marked).

### STEP 4: Index BAM file
1. Indexing creates a shortcut list for your BAM file. It allows rapid retrieval of alignments overlapping specific genomic regions without loading the entire BAM file. Many genome browsers (like IGV) and tools (like `samtools view`, `gatk`, etc.) require indexed BAMs to work with specific regions.
2. Command:
   ```
   samtools index sample_name.markdup.bam
   ```
   The output will be `sample.markdup.bam.bai`.

### STEP 5: Base Quality Score Recalibration (BQSR)
1. BQSR aims to correct systematic errors made by the sequencer when it estimates the accuracy of each base call.
2. Command:
     1. `gatk BaseRecalibrator`
   ```
   gatk BaseRecalibrator -R $REF -I sample_name.markdup.bam --known-sites $KNOWN_SITES -O sample_name.recal_data.table
   ```
   * Purpose: Looks for consistent errors in how the sequencer reports base quality scores and builds a model to fix those errors.
   * Parameter explanation:
       * `-R $REF`: Reference genome FASTA file.
       * `-I sample_name.markdup.bam`: Input BAM file with duplicate reads marked.
       * `--known-sites $KNOWN_SITES`: Known variant sites (e.g., dbSNP, 1000G, Mills indels) used to identify sites where mismatches should not be penalized.
       * `-O sample_name.recal_data.table`: Output file containing recalibration data/statistics.
    * What it does: It builds a recalibration model by comparing the bases in the reads to the reference genome and the known variants. Systematic biases (e.g., due to machine cycle or context) are detected and recorded.
   2. `gatk ApplyBQSR`
      ```
      gatk ApplyBQSR -R $REF -I sample_name.markdup.bam --bqsr-recal-file sample_name.recal_data.table -O sample_name_bqsr.bam
      ```
     * Purpose: Applies the recalibration model to the original BAM file to adjust the base quality scores.
     * Parameter explanation:
         * `--bqsr-recal-file sample.recal_data.table`: The model/data generated from the previous step.
         * `-O sample_name_bqsr.bam`: Output BAM file with recalibrated base quality scores.
      
### STEP 6: Validate BAM file
1. This command checks if your BAM file follows the proper format and rules.
2. Purpose:
     * Make sure your BAM file is valid.
     * Catch formatting errors or issues that might cause problems in later analysis steps like variant calling.
     * Ensure smooth workflow — a bad BAM file can crash downstream tools or give wrong results.
3. Command:
   ```
   gatk ValidateSamFile -I sample_name_bqsr.bam -MODE SUMMARY
   ```
4. Parameter explanantion:
     * `gatk ValidateSamFile` - This tool in GATK checks SAM/BAM files for format errors.
     * `-MODE SUMMARY` - This tells GATK how much detail to show.
       `SUMMARY` mode means:
         * Show only a summary of the types of problems found.
         * Don’t print every single issue (which can be huge for big files).
         * It’s faster and cleaner to read.

### STEP 7: Convert BAM to VCF using Mutect2
1. Mutect2 is a tool used to identify somatic mutations.
2. Command:
     1. `gatk Mutect2`
        ```
        gatk Mutect2 -R $REF -I sample_name_bqsr.bam -O sample_name_unfiltered_variants.vcf -L $BED
        ```
           * What it does: It runs `Mutect2` to find possible somatic mutations (variants) in the sample. The output is a list of these mutations in a file called `sample_name_unfiltered_variants.vcf`. It will only look in specific regions of the genome defined in the BED file (`$BED`), and the output will be written to a VCF file.
           * Parameter explanation:
                * `gatk Mutect2` --> Run GATK's somatic variant caller.
                * `-O sample_name_unfiltered_variants.vcf` --> Output file where variant calls will go
                * `-L $BED` -->	Limit variant calling to specific regions defined in a BED file (e.g., exome or cancer gene panel)
   
      2. `gatk FilterMutectCalls`
           ```
           gatk FilterMutectCalls -R $REF -V sample_name_unfiltered_variants.vcf -O sample_name_filtered_variants.vcf -L $BED
           ```
           * What it does: It filters out false positives from the first output and gives you a cleaner list of likely real mutations in `sample_name_filtered_variants.vcf`. Not every "mutation" found by Mutect2 is real — some are due to sequencing errors, artifacts, or noise. This step helps keep only the high-confidence mutations.
           * Parameter explanation:
              * `FilterMutectCalls` --> GATK tool to filter variants after Mutect2.
              * `-V sample_unfiltered_variants.vcf` --> Input file with unfiltered variant calls from Mutect2.
              * `-O sample_filtered_variants.vcf` --> Output file with filtered, high-confidence variant calls.

#### NOTE:
**_For smooth execution of the pipeline, its better to run the above mentioned commands individually first and debug if any errors arise. Post that compile all the commands in a shell script._**

        
     



             


    

    
    
      




       
   

        
        
        







